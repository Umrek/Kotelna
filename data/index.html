<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kotelna - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body{font-family:sans-serif; text-align:center; background:#f0f2f5; padding:10px;}
        .box{background:white; padding:15px; margin:15px auto; border-radius:10px; max-width:900px; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
        .chart-container{position:relative; height:350px; width:100%;}
        .progress{width:200px; background:#ddd; height:10px; border-radius:5px; margin:5px auto;}
        .bar{height:100%; border-radius:5px;}
        button{padding:6px 12px; margin:2px; cursor:pointer; background:#fff; border:1px solid #ccc; border-radius:4px;}
        button:hover{background:#eee;}
        .temp-val{font-weight:bold;}
        .spaliny{color:red;}
    </style>
</head>
<body>
    <h2>Kotelna - Dashboard</h2>
    
    <div class="box">
        <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 15px;">        
            <span>Uptime: <span id="uptimeDisp">-d --:--:--</span></span>  
            <span>WiFi: <b id="rssiDisp">---</b> dBm <span id="wifiQual"></span></span>
            <span style="font-weight: bold;">Posledn칤 update: <span id="lastUpdateDisp" style="color: blue;">--:--:--</span></span>
        </div>
    </div>

    <div class="box">
        <b>Rozsah graf콢:</b>
        <button onclick="setRange(36, this)">6h</button>
        <button id="btnDefault" style="background:#ddd" onclick="setRange(72, this)">12h</button>
        <button onclick="setRange(144, this)">24h</button>
        <button onclick="setRange(288, this)">48h</button>
    </div>

    <div class="box">
        <h3>1. Teplota Kotle a Spalin</h3>
        <div style="display:flex; justify-content:center; flex-wrap:wrap; gap:15px; margin-bottom:15px;">
            <div>Vstup: <span id="temp0" class="temp-val">--</span>춿C</div>
            <div>V칳stup: <span id="temp1" class="temp-val">--</span>춿C</div>
            <div class="spaliny">Spaliny: <span id="tempSpal" class="temp-val">--</span>춿C</div>
        </div>
        <div class="chart-container"><canvas id="chartKotel"></canvas></div>
    </div>

    <div class="box">
        <h3>2. Akumula캜n칤 n치dr쬰</h3>
        <div style="display:flex; justify-content:center; flex-wrap:wrap; gap:15px; margin-bottom:15px;">
            <div>Horn칤: <span id="temp2" class="temp-val">--</span>춿C</div>
            <div>St콏ed 1: <span id="temp3" class="temp-val">--</span>춿C</div>
            <div>St콏ed 2: <span id="temp4" class="temp-val">--</span>춿C</div>
            <div>Doln칤: <span id="temp5" class="temp-val">--</span>춿C</div>
        </div>
        <div class="chart-container"><canvas id="chartAku"></canvas></div>
    </div>

    <div class="box">
        <h3>3. Venkovn칤 teplota</h3>
        <div style="margin-bottom:10px;">Aktu치ln캩 venku: <span id="temp6" class="temp-val">--</span>춿C</div>
        <div class="chart-container"><canvas id="chartVenku"></canvas></div>
    </div>

    <div class="box" style="background: #fff5f5; border: 1px solid #ffcccc;">
        <h3>游 Servisn칤 funkce</h3>
        <div style="display:flex; justify-content:center; flex-wrap:wrap; gap:10px;">
            <button onclick="location.href='/list_page'" style="background:#e3f2fd; border-color:#2196f3;">游늵 Tabulka historie</button>
            <button onclick="location.href='/scan'" style="background:#e8f5e9; border-color:#4caf50;">游댌 Skenovat 캜idla</button>
            <button onclick="downloadHistory()" style="background:#e1f5fe; border-color:#03a9f4;">游 St치hnout z치lohu CSV</button>
            <button onclick="showErrorLogs()" style="background:#ffcccc; border-color:#f44336;">丘멆잺 Zobrazit chyby 캜idel</button>
            <button onclick="if(confirm('Opravdu restartovat?')) location.href='/restart'" style="background:#fff3e0; border-color:#ff9800;">游댃 Restartovat ESP</button>
            <button onclick="handleDelete()" style="background:#ffebee; border-color:#f44336; color:red; font-weight:bold;">游딈 Smazat historii!</button>
        </div>

        <div id="errorLogTable" style="margin-top:20px; font-family:monospace; font-size:0.85em; display:none; background:white; border:1px solid #ffcccc; padding:10px; border-radius:5px; text-align:left; max-height:300px; overflow-y:auto;">
        </div>
    </div>

    <script>
        var rawData = [];
        var currentRange = 72; // V칳choz칤 zobrazen칤 12 hodin (72 z치znam콢 po 10 minut치ch)
        var cKotel = null, cAku = null, cVenku = null;

        // HLAVN칈 SPOUT캨캛 PO NA캛TEN칈 STR츼NKY
        window.onload = async function() {
            console.log("Str치nka na캜tena, inicializuji...");
            initCharts();        // 1. Vytvo콏칤 pr치zdn칠 grafy (b칤l치 pl치tna)
            await loadHistory(); // 2. Po캜k치 na sta쬰n칤 dat z ESP32
            refreshCharts();     // 3. Vlo쮂 sta쬰n치 data do graf콢
            updateDashboard();   // 4. Na캜te aktu치ln칤 teploty a spust칤 smy캜ku
            setInterval(updateDashboard, 60000);
        };

        async function loadHistory() {
            try {
                console.log("Stahuji historii...");
                const res = await fetch('/api/history');
                const text = await res.text();
                
                if (!text || text === "no_data") {
                    console.log("Historie je pr치zdn치.");
                    return;
                }

                const lines = text.trim().split('\n');
                rawData = lines.map(line => {
                    return line.replace(/"/g, '').split(',').map(s => s.trim());
                }).filter(p => p.length >= 8);

                console.log("칔sp캩코n캩 zpracov치no 콏치dk콢: " + rawData.length);
            } catch (e) { 
                console.error('Chyba p콏i loadHistory:', e); 
            }
        }

        async function updateDashboard() {
            try {
                const res = await fetch('/api/data');
                if (!res.ok) throw new Error("Server neodpov칤d치");
                const d = await res.json();

                // 캛as aktualizace
                const ted = new Date();
                const casString = ted.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'});
                const lastUpEl = document.getElementById('lastUpdateDisp');
                lastUpEl.innerText = casString;
                
                // Vizu치ln칤 zp캩tn치 vazba
                lastUpEl.style.color = "green";
                setTimeout(() => { lastUpEl.style.color = "blue"; }, 500);

                // UPTIME a RSSI - p콏id치na kontrola existence
                if (d.uptime) document.getElementById('uptimeDisp').innerText = d.uptime;
                
                if (d.rssi !== undefined) {
                    const rssi = d.rssi;
                    const rssiEl = document.getElementById('rssiDisp');
                    const qualEl = document.getElementById('wifiQual');
                    rssiEl.innerText = rssi;
                    
                    if (rssi > -60) { qualEl.innerText = "游릭 V칳born칳"; rssiEl.style.color = "green"; }
                    else if (rssi > -75) { qualEl.innerText = "游리 Dobr칳"; rssiEl.style.color = "orange"; }
                    else { qualEl.innerText = "游댮 Slab칳"; rssiEl.style.color = "red"; }
                }

                // Teploty S1-S7
                if (d.t && Array.isArray(d.t)) {
                    d.t.forEach((val, i) => { 
                        const el = document.getElementById('temp' + i);
                        if(el) el.innerText = (val < -50) ? "CHYBA" : val.toFixed(1);
                    });
                }
                
                // Spaliny
                if (d.spal !== undefined) {
                    document.getElementById('tempSpal').innerText = d.spal.toFixed(0);
                }

                // P콏id치n칤 do grafu (jen pokud m치me v코echna data)
                if (d.t && d.spal !== undefined) {
                    let nowCas = ted.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    rawData.push([nowCas, ...d.t.map(v => v.toString()), d.spal.toString()]);
                    if(rawData.length > 3000) rawData.shift();
                    refreshCharts();
                }

            } catch(e) { 
                console.error('Update selhal:', e); 
                document.getElementById('lastUpdateDisp').innerText = "CHYBA SPOJEN칈";
                document.getElementById('lastUpdateDisp').style.color = "red";
            }
        }

        function initCharts() {
            // Prevence chyby "Canvas is already in use"
            if (cKotel) cKotel.destroy();
            if (cAku) cAku.destroy();
            if (cVenku) cVenku.destroy();

            cKotel = drawGraph('chartKotel', [], [
                {label:'Vstup', borderColor:'blue', data: []},
                {label:'V칳stup', borderColor:'orange', data: []},
                {label:'Spaliny', borderColor:'red', data: []}
            ]);
            cAku = drawGraph('chartAku', [], [
                {label:'Horn칤', borderColor:'darkred', data: []},
                {label:'St콏ed 1', borderColor:'red', data: []},
                {label:'St콏ed 2', borderColor:'orange', data: []},
                {label:'Doln칤', borderColor:'blue', data: []}
            ]);
            cVenku = drawGraph('chartVenku', [], [
                {label:'Venkovn칤', borderColor:'green', data: []}
            ]);
        }

        function drawGraph(id, labels, datasets) {
            // Vytvo콏칤 nov칳 graf s dan칳m ID, pr치zdn칳mi 코t칤tky a datasetemi. 
            // Nastaven칤 je optimalizov치no pro rychl칠 na캜칤t치n칤 a p콏ehlednost. 
            // Animace jsou vypnut칠, zobrazen칤 je responzivn칤, a osy jsou nastaveny tak, aby zobrazovaly pouze ka쬯칳 10. 코t칤tek pro lep코칤 p콏ehlednost. 
            // Legenda je um칤st캩na dole a zobrazuje pouze n치zvy bez ikon. 
            // Body jsou skryt칠 a k콏ivky jsou zjemn캩n칠 pro lep코칤 vizu치ln칤 dojem.
            return new Chart(document.getElementById(id), {
                type: 'line',
                data: {labels: labels, datasets: datasets},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    animation: false, // Vypneme animace pro rychlej코칤 na캜칤t치n칤
                    scales: {
                        y: { 
                            ticks: { stepSize: 5 } // Nastav칤 krok na 5춿C pro lep코칤 캜itelnost
                        },
                        x: {
                            ticks: {
                                // Automaticky vybere popisky tak, aby se nep콏ekr칳valy
                                autoSkip: true,
                                maxTicksLimit: 12, // Maxim치ln캩 12 popisk콢 na celou 코칤콏ku (cca co hodina u 12h rozsahu)
                                maxRotation: 0,
                                minRotation: 0
                            },
                            grid: {
                                display: false // Voliteln칠: vypne svisl칠 캜치ry m콏칤쬶y, graf bude 캜ist코칤
                            }
                        }
                    },
                    // Legenda dole a bez zbyte캜n칳ch ikon
                    plugins: { legend: { position: 'bottom' } },
                    // Odstran칤me body a zjemn칤me k콏ivky
                    elements: { point: { radius: 0 }, line: { tension: 0.2 } }
                }
            });
        }

        function refreshCharts() {
            if(!cKotel || rawData.length === 0) return;
            
            const viewData = rawData.slice(-currentRange);
            const lbls = viewData.map(r => r[0]);

            const up = (c, idxs) => {
                c.data.labels = lbls;
                
                c.data.datasets.forEach((ds, i) => { 
                    let lastValidValue = null; // Pomocn치 prom캩nn치 pro "Forward Fill"
                    
                    ds.data = viewData.map(r => {
                        let val = parseFloat(r[idxs[i]]);
                        
                        if (val > -50) {
                            // Hodnota je v po콏치dku, ulo쮂셠e ji jako posledn칤 platnou
                            lastValidValue = val;
                            return val;
                        } else {
                            // Hodnota je chybn치 (-127), zkus칤me pou쮂셦 tu p콏edchoz칤
                            // Pokud nem치me ani p콏edchoz칤 (chyba hned na za캜치tku), vr치t칤me null
                            return lastValidValue;
                        }
                    });
                });
                
                c.update('none');
            };

            up(cKotel, [1, 2, 8]);
            up(cAku, [3, 4, 5, 6]);
            up(cVenku, [7]);
        }

        function setRange(p, btn) {
            currentRange = p;
            // Zv칳razn칤me aktivn칤 tla캜칤tko
            var btns = btn.parentNode.getElementsByTagName('button');
            // Reset v코ech tla캜칤tek
            for(var i=0; i<btns.length; i++) btns[i].style.background = '#fff';
            // Zv칳razn칤me aktu치ln칤
            btn.style.background = '#ddd';
            // Obnov칤me grafy s nov칳m rozsahem
            refreshCharts();
        }

        function downloadHistory() {
            const link = document.createElement("a");
            link.href = "/api/history";
            link.download = "history.csv";
            link.click();
        }

        function showErrorLogs() {
            const tableDiv = document.getElementById('errorLogTable');
            // Najdeme 콏치dky, kde je n캩kter치 hodnota (od indexu 1 do 7) men코칤 ne -50
            const errorRows = rawData.filter(r => {
                for(let i=1; i<=7; i++) {
                    if(parseFloat(r[i]) < -50) return true;
                }
                return false;
            });

            if (errorRows.length === 0) {
                alert("V na캜ten칠 historii nejsou 쮂멳n칠 chyby 캜idel.");
                tableDiv.style.display = 'none';
                return;
            }

            let html = "<strong>Nalezen칠 chyby (celkem " + errorRows.length + "):</strong><br>";
            html += "<table border='1' style='width:100%; border-collapse: collapse;'>";
            errorRows.forEach(r => {
                html += "<tr><td>" + r.join("</td><td>") + "</td></tr>";
            });
            html += "</table>";
            
            tableDiv.innerHTML = html;
            tableDiv.style.display = 'block';
        }

        function handleDelete() {
            if (confirm('VAROV츼N칈: Ve코ker치 historie bude smaz치na. Pokra캜ovat?')) {
                location.href = '/delete';
            }
        }

        // Tik치n칤 uptime ka쬯ou vte콏inu na stran캩 prohl칤쬰캜e
        setInterval(function() {
            let el = document.getElementById('uptimeDisp');
            let text = el.innerText;
            
            // Rozpozn치n칤 form치tu "1d 02:15:05" pomoc칤 regul치rn칤ho v칳razu
            let match = text.match(/(\d+)d\s+(\d+):(\d+):(\d+)/);
            if (!match) return;

            let d = parseInt(match[1]);
            let h = parseInt(match[2]);
            let m = parseInt(match[3]);
            let s = parseInt(match[4]);

            s++;
            if (s >= 60) { s = 0; m++; }
            if (m >= 60) { m = 0; h++; }
            if (h >= 24) { h = 0; d++; }

            el.innerText = d + "d " + 
                String(h).padStart(2, '0') + ":" + 
                String(m).padStart(2, '0') + ":" + 
                String(s).padStart(2, '0');
        }, 1000);
    </script>
</body>
</html>