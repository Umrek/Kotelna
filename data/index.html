<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kotelna - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body{font-family:sans-serif; text-align:center; background:#f0f2f5; padding:10px;}
        .box{background:white; padding:15px; margin:15px auto; border-radius:10px; max-width:900px; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
        .chart-container{position:relative; height:350px; width:100%;}
        button{padding:6px 12px; margin:2px; cursor:pointer; background:#fff; border:1px solid #ccc; border-radius:4px;}
        button:hover{background:#eee;}
        .temp-val{font-weight:bold;}
        .spaliny{color:red;}
        #lastUpdateDisp{font-weight: bold;}
        /* Styl pro kontejner li코ty */
        .progress {
            width: 100px;
            background: #eee;
            height: 12px;
            border-radius: 6px;
            display: inline-block;
            vertical-align: middle;
            margin: 0 5px;
            border: 1px solid #ccc;
            overflow: hidden; /* Aby vnit콏n칤 bar nep콏et칠kal p콏es zaoblen칤 */
        }

        /* Styl pro vnit콏n칤 barevnou 캜치st */
        .bar {
            height: 100%;
            width: 0%; /* Za캜칤n치 na nule, JS ji nat치hne */
            background: #4caf50;
            transition: width 0.5s ease-in-out; /* Plynul칳 pohyb */
        }
    </style>
</head>
<body>
    <h2>Kotelna - Dashboard</h2>
    
    <div class="box">
        <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 15px;">        
            <span>Uptime: <span id="uptimeDisp">-d --:--:--</span></span>  
            <span>
                RAM: <b id="heapDisp">---</b> kB 
                <div class="progress">
                    <div id="heapBar" class="bar"></div>
                </div>
            </span>
            <span>WiFi: <b id="rssiDisp">---</b> dBm <span id="wifiQual"></span></span>
            <span>Posledn칤 update: <span id="lastUpdateDisp" style="color: blue;">--:--:--</span></span>
        </div>
    </div>

    <div class="box">   
        <b>Rozsah graf콢:</b>
        <button onclick="setRange(360, this)">6h</button>
        <button id="btnDefault" style="background:#ddd" onclick="setRange(720, this)">12h</button>
        <button onclick="setRange(1440, this)">24h</button>
        <button onclick="setRange(2880, this)">48h</button>
    </div>

    <div class="box">
        <h3>1. Teplota Kotle a Spalin</h3>
        <div style="display:flex; justify-content:center; flex-wrap:wrap; gap:15px; margin-bottom:15px;">
            <div>Vstup: <span id="temp0" class="temp-val">--</span>춿C</div>
            <div>V칳stup: <span id="temp1" class="temp-val">--</span>춿C</div>
            <div class="spaliny">Spaliny: <span id="tempSpal" class="temp-val">--</span>춿C</div>
        </div>
        <div class="chart-container"><canvas id="chartKotel"></canvas></div>
    </div>

    <div class="box">
        <h3>2. Akumula캜n칤 n치dr쬰</h3>
        <div style="display:flex; justify-content:center; flex-wrap:wrap; gap:15px; margin-bottom:15px;">
            <div>Horn칤: <span id="temp2" class="temp-val">--</span>춿C</div>
            <div>St콏ed 1: <span id="temp3" class="temp-val">--</span>춿C</div>
            <div>St콏ed 2: <span id="temp4" class="temp-val">--</span>춿C</div>
            <div>Doln칤: <span id="temp5" class="temp-val">--</span>춿C</div>
        </div>
        <div class="chart-container"><canvas id="chartAku"></canvas></div>
    </div>

    <div class="box">
        <h3>3. Venkovn칤 teplota</h3>
        <div style="margin-bottom:10px;">Aktu치ln캩 venku: <span id="temp6" class="temp-val">--</span>춿C</div>
        <div class="chart-container"><canvas id="chartVenku"></canvas></div>
    </div>

    <div class="box" style="background: #fff5f5; border: 1px solid #ffcccc;">
        <h3>游 Servisn칤 funkce</h3>
        <div style="display:flex; justify-content:center; flex-wrap:wrap; gap:10px;">
            <button onclick="location.href='/list_page'" style="background:#e3f2fd; border-color:#2196f3;">游늵 Tabulka historie</button>
            <button onclick="location.href='/scan'" style="background:#e8f5e9; border-color:#4caf50;">游댌 Skenovat 캜idla</button>
            <button onclick="downloadHistory()" style="background:#e1f5fe; border-color:#03a9f4;">游 St치hnout z치lohu CSV</button>
            <button onclick="showErrorLogs()" style="background:#ffcccc; border-color:#f44336;">丘멆잺 Zobrazit chyby 캜idel</button>
            <button onclick="if(confirm('Opravdu restartovat?')) location.href='/restart'" style="background:#fff3e0; border-color:#ff9800;">游댃 Restartovat ESP</button>
            <button onclick="handleDelete()" style="background:#ffebee; border-color:#f44336; color:red; font-weight:bold;">游딈 Smazat historii!</button>
        </div>
        <div id="errorLogTable" style="margin-top:20px; font-family:monospace; font-size:0.85em; display:none; background:white; border:1px solid #ffcccc; padding:10px; border-radius:5px; text-align:left; max-height:300px; overflow-y:auto;"></div>
    </div>

    <script>
        // --- GLOB츼LN칈 KONFIGURACE ---
        var rawData = [];
        var currentRange = 720; // V칳choz칤 rozsah v minut치ch (12h)
        var graphStep = 10;     // Pro콏ed캩n칤: vz칤t ka쬯ou 10. minutu pro graf
        
        var cKotel = null, cAku = null, cVenku = null;

        window.onload = async function() {
            initCharts();
            await loadHistory(); 
            refreshCharts();
            updateDashboard();
            setInterval(updateDashboard, 60000); // Live update ka쬯ou minutu
        };

        async function loadHistory() {
            try {
                const res = await fetch('/api/history');
                const text = await res.text();
                if (!text || text === "no_data") return;

                const lines = text.trim().split('\n');
                rawData = lines.map(line => {
                    return line.replace(/"/g, '').split(',').map(s => s.trim());
                }).filter(p => p.length >= 8);
                console.log("Historie na캜tena: " + rawData.length + " 콏치dk콢");
            } catch (e) { console.error('Chyba loadHistory:', e); }
        }

        async function updateDashboard() {
            try {
                const res = await fetch('/api/data');
                const d = await res.json();

                // 캛as a vizu치ln칤 update
                const ted = new Date();
                const lastUpEl = document.getElementById('lastUpdateDisp');
                lastUpEl.innerText = ted.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
                lastUpEl.style.color = "green";
                setTimeout(() => { lastUpEl.style.color = "blue"; }, 500);

                if (d.uptime) document.getElementById('uptimeDisp').innerText = d.uptime;
                
                if (d.rssi !== undefined) {
                    const rssiEl = document.getElementById('rssiDisp');
                    rssiEl.innerText = d.rssi;
                    document.getElementById('wifiQual').innerText = d.rssi > -60 ? "游릭 V칳born칳" : (d.rssi > -75 ? "游리 Dobr칳" : "游댮 Slab칳");
                }

                if (d.t) {
                    d.t.forEach((val, i) => {
                        const el = document.getElementById('temp' + i);
                        if(el) el.innerText = (val < -50) ? "CHYBA" : val.toFixed(1);
                    });
                }
                if (d.spal !== undefined) document.getElementById('tempSpal').innerText = d.spal.toFixed(0);

                // P콏id치n칤 쬴v칠ho bodu do pam캩ti a refresh grafu
                if (d.t && d.spal !== undefined) {
                    let nowCas = ted.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    rawData.push([nowCas, ...d.t.map(v => v.toString()), d.spal.toString()]);
                    if(rawData.length > 4000) rawData.shift(); 
                    refreshCharts();
                }

                if (d.uptime) document.getElementById('uptimeDisp').innerText = d.uptime;

                if (d.free_heap !== undefined) {
                    const freeKb = Math.round(d.free_heap / 1024);
                    document.getElementById('heapDisp').innerText = freeKb;
                    
                    // V칳po캜et procenta (p콏edpokl치d치me cca 250kB jako max pro ESP32)
                    const maxRam = 250; 
                    let perc = Math.round((freeKb / maxRam) * 100);
                    if (perc > 100) perc = 100;
                    if (perc < 0) perc = 0;

                    const bar = document.getElementById('heapBar');
                    if (bar) {
                        bar.style.width = perc + "%";
                        // Barva podle zb칳vaj칤c칤 pam캩ti
                        if (freeKb > 100) bar.style.background = "#4caf50";      // Zelen치
                        else if (freeKb > 50) bar.style.background = "#ff9800"; // Oran쬺v치
                        else bar.style.background = "#f44336";                 // 캛erven치
                    }
                }
            } catch(e) { console.error('Update selhal:', e); }
        }

        function initCharts() {
            cKotel = drawGraph('chartKotel', [
                {label:'Vstup', borderColor:'blue'}, {label:'V칳stup', borderColor:'orange'}, {label:'Spaliny', borderColor:'red'}
            ]);
            cAku = drawGraph('chartAku', [
                {label:'Horn칤', borderColor:'darkred'}, {label:'St콏ed 1', borderColor:'red'}, {label:'St콏ed 2', borderColor:'orange'}, {label:'Doln칤', borderColor:'blue'}
            ]);
            cVenku = drawGraph('chartVenku', [{label:'Venkovn칤', borderColor:'green'}]);
        }

        function drawGraph(id, datasets) {
            return new Chart(document.getElementById(id), {
                type: 'line',
                data: { labels: [], datasets: datasets.map(d => ({...d, data: [], borderWidth: 2})) },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    elements: { point: { radius: 0 }, line: { tension: 0.2 } },
                    scales: {
                        x: { ticks: { autoSkip: true, maxTicksLimit: 12, maxRotation: 0 } },
                        y: { ticks: { stepSize: 5 } }
                    },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function refreshCharts() {
            if(!cKotel || rawData.length === 0) {
                console.log("콯치dn치 data pro grafy!");
                return;
            }
            
            // O콏칤zneme data na po쬬dovan칳 po캜et minut
            let viewData = rawData.slice(-currentRange);
            console.log("Vykresluji bod콢: " + viewData.length);

            // Pro콏ed캩n칤: aplikujeme ho, jen pokud m치me v칤c dat, ne je krok
            if (viewData.length > graphStep) {
                viewData = viewData.filter((_, index, arr) => {
                    return (index % graphStep === 0) || (index === arr.length - 1);
                });
            }

            const lbls = viewData.map(r => r[0]);
            const updateSet = (chart, indices) => {
                chart.data.labels = lbls;
                chart.data.datasets.forEach((ds, i) => {
                    let last = null;
                    ds.data = viewData.map(r => {
                        let v = parseFloat(r[indices[i]]);
                        if (v > -50) { last = v; return v; }
                        return last;
                    });
                });
                chart.update('none');
            };

            updateSet(cKotel, [1, 2, 8]);
            updateSet(cAku, [3, 4, 5, 6]);
            updateSet(cVenku, [7]);
        }

        function setRange(min, btn) {
            currentRange = min;
            const btns = btn.parentNode.getElementsByTagName('button');
            for(let b of btns) b.style.background = '#fff';
            btn.style.background = '#ddd';
            refreshCharts();
        }

        function downloadHistory() {
            const a = document.createElement("a");
            a.href = "/api/history"; a.download = "history.csv"; a.click();
        }

        function showErrorLogs() {
            const div = document.getElementById('errorLogTable');
            const errs = rawData.filter(r => {
                for(let i=1; i<=7; i++) if(parseFloat(r[i]) < -50) return true;
                return false;
            });
            if (errs.length === 0) { alert("콯치dn칠 chyby."); div.style.display='none'; return; }
            let h = "<strong>Chyby (" + errs.length + "):</strong><table border='1' style='width:100%; border-collapse:collapse;'>";
            errs.slice(-50).forEach(r => h += "<tr><td>" + r.join("</td><td>") + "</td></tr>");
            div.innerHTML = h + "</table>"; div.style.display = 'block';
        }

        function handleDelete() { if(confirm('Smazat v코e?')) location.href='/delete'; }

        // Uptime ticker
        setInterval(() => {
            let el = document.getElementById('uptimeDisp');
            let m = el.innerText.match(/(\d+)d\s+(\d+):(\d+):(\d+)/);
            if (!m) return;
            let d=parseInt(m[1]), h=parseInt(m[2]), min=parseInt(m[3]), s=parseInt(m[4]);
            if (++s >= 60) { s=0; if (++min >= 60) { min=0; if (++h >= 24) { h=0; d++; } } }
            el.innerText = d + "d " + String(h).padStart(2,'0') + ":" + String(min).padStart(2,'0') + ":" + String(s).padStart(2,'0');
        }, 1000);
    </script>
</body>
</html>